<!DOCTYPE html>
<html>
    <title>제목이다</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">

    <head>
        <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.3/xlsx.full.min.js"></script>
        <script src='dir.php'></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" style="width: 100%; height:auto">

        <style type="text/css">
            html, body{
                margin:0;
                height: 100%;
            }
            /*전체UI*/
            #containner{
                position:relative;
                display: -webkit-flex;
                display: flex;
                flex-direction: row;
                margin:auto;
                flex-wrap : wrap;
                width: 100%;
                text-align: center;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-align-items: center;
                align-items: center;
            }
            #phoneName{
                margin-top:20px;
                margin-bottom:20px;
                width:100%;
            }

            /*왼쪽 div*/
            #containner_left{
                width:450px;
                height: 400px;
                margin-left: 20px;
                margin-right: 20px;
                margin-bottom: 20px;
            }
            #color_pick{
                height:61px;
                margin-top: 20px;
                display: inline-block;
            }
            .color_pick_sub{
                float:left;
                margin:0px 15px;
            }
            .color_pick_sub img{
                transform:scale(1); 
                transition:transform 0.3s linear;
            }
            .color_pick_sub:hover img{
                transform: scale(1.3);
                -webkit-transform: scale(1.3);
                -moz-transform: scale(1.3);
                -ms-transform: scale(1.3);
                -o-transform: scale(1.3);
                
            }
            .color_text{
                margin-top: 5px;
            }

            /*가운데 div*/
            #containner_center{
                width:450px;
                height: 400px;
                margin-left: 20px;
                margin-right: 20px;
            }
            .center_item_head{
                height: 20px;
                margin-top:35px;
            }
            .center_item{
                height: 20px;
                margin-top:35px;
            }
            .center_sub{
                float: left;
            }
            .center_value{
            }

            /*오른쪽 div*/
            #containner_right{
                display: table-cell;
                vertical-align: middle;
                width:450px;
                height: 400px;
                margin-left: 20px;
                margin-right: 20px;
                margin-bottom: 20px;
            }
            .right_item_head{
                height: 20px;
                margin-top:30px;

            }
            .right_item{
                height: 20px;
                margin-top: 10px;
                padding-top:1%;
            }
            .right_sub{
                float: left;
            }
            .right_value{
                float: right;
            }
            .calc_ui{
                display:inline-block;
            }
                /* 오른쪽 최종계산 UI*/
                .calc_tap1{
                    width:90px;
                    float:left;
                }
                .calc_tap2{
                    width:45px;
                    float:left;
                }
                .calc_tap3{
                    width:90px;
                    float:left;
                }
                .calc_tap4{
                    width:45px;
                    float:left;
                }
                .calc_tap5{
                    width:90px;
                    float:left;
                }
            #special_discount, #calc_result3{
                color:red;
            }
            /*약정할인일 때에만 display:block*/
            #total_sale_contract{
                display: none;
            }
            #select_color, #select_after_service, #select_info, #get_money, #total_sale_contract, #phone_price, #last_price_phone, #month_price_ui{
                background-color: #F4F4F4;
            }

        </style>
    </head>
        <body>
            <!--전체 랩-->
            <div id = "containner">
                <!--상단 핸드폰 이름 -->
                <div id="phoneName" >
                </div>
                <!--왼쪽 이미지-->
                <div id="containner_left">
                    <!--핸드폰 이미지 나오는 div-->
                    <div id="main_image_div">
                    </div>
                    <!--색상 고르는 div 시작-->
                    <div id="color_pick">
                    </div>
                </div><!--왼쪽 끝-->
                <!--가운데 표-->
                <div id="containner_center">
                    <div id="select_color" class="center_item_head">
                        <div class="center_sub">
                            색상
                        </div>
                        <div id="radio_color" class="center_value"  >
                        </div>
                    </div>
                    <div id="select_now_service" class="center_item">
                        <div class="center_sub">
                            사용중인 통신사
                        </div>
                        <div id="now_service" class="center_value"  >
                            <label>
                                <input class="radio_service" type="radio" name="radio_now_service" value="sk" checked>
                                SK
                            </label>
                            <label>
                                <input class="radio_service" type="radio" name="radio_now_service" value="kt" >
                                KT
                            </label>
                            <label>
                                <input class="radio_service" type="radio" name="radio_now_service" value="lg" >
                                LG
                            </label>
                            <label>
                                <input class="radio_service" type="radio" name="radio_now_service" value="etc" >
                                알뜰폰
                            </label>
                        </div>
                    </div>
                    <div id="select_after_service" class="center_item">
                        <div class="center_sub">
                            사용하실 통신사
                        </div>
                        <div id="after_service" class="center_value"  >
                            <label>
                            <input class="radio_service" type="radio" name="radio_after_service" value="sk" checked>
                            SK
                        </label>
                        </div>
                    </div>
                    <div id="select_contract" class="center_item">
                        <div class="center_sub">
                            약정 선택
                        </div>
                        <div id="contract" class="center_value" >
                            <label>
                                <input class="radio_calc" type="radio" name="radio_contract" value="공시" checked>
                                공시지원금(선택약정)
                            </label>
                            <label>
                                <input class="radio_calc" type="radio" name="radio_contract" value="선약" >
                                요금제할인
                            </label>
                        </div>
                    </div>
                    <div id="select_info" class="center_item">
                        <div class="center_sub">
                            할부개월
                        </div>
                        <div id="info" class="center_value"  >
                            <label>
                                <input class="radio_calc" type="radio" name="radio_month" value="24" checked>
                                24개월
                            </label>
                            <label>
                                <input class="radio_calc" type="radio" name="radio_month" value="36" >
                                36개월
                            </label>
                            <label>
                                <input class="radio_calc" type="radio" name="radio_month" value="48" >
                                48개월
                            </label>
                        </div>
                    </div>
                    <div class="center_item">
                        <div class="center_sub">
                            요금제
                        </div>
                        <div id="plans" class="center_value"  >
                            <select id="select_plan" class="radio_calc">
                                </select>
                        </div>

                    </div>
                </div><!--가운데 끝-->
                <!--오른쪽 표-->
                <div id="containner_right">
                    <div id="phone_price" class="right_item_head">
                        <div class="right_sub">
                            출고가
                        </div>
                        <div id="phone_price_value" class="right_value">
                        </div>
                    </div>
                    <!--사용자가 입력 가능한 값-->
                    <div id="special_discount" class="right_item">
                        <div class="right_sub">
                            특별할인
                        </div>
                        <div id="special_discount_value" class="right_value">
                        </div>
                    </div>
                    <div id="last_price_phone" class="right_item">
                        <div id="tt" class="right_sub">
                            할부원금
                        </div>
                        <div id="last_price_phone_value" class="right_value">
                        </div>
                    </div>
                    <div id="installment_month" class="right_item">
                        <div class="right_sub">
                            할부개월
                        </div>
                        <div id="installment_month_value" class="right_value">
                        </div>
                    </div>
                    <div id="plan" class="right_item">
                        <div class="right_sub">
                            요금제
                        </div>
                        <div id="plan_value"  class="right_value">
                        </div>
                    </div>
                    <div id="month_price_ui" class="right_item">
                        <div class="calc_ui">
                            <div class="calc_tap1">
                                월 할부원금
                            </div>
                            <div class="calc_tap2">
                                +
                            </div>
                            <div class="calc_tap3">
                                통신요금
                            </div>
                            <div class="calc_tap4">
                                =
                            </div>
                            <div class="calc_tap5">
                                월 납부금액
                            </div>
                        </div>
                    </div>
                    <div id="month_price_calc" class="right_item">
                        <div class="calc_ui">
                            <div id="calc_result1" class="calc_tap1">
                                loading...
                            </div>
                            <div class="calc_tap2">
                                +
                            </div>
                            <div id="calc_result2" class="calc_tap3">
                                loading...
                            </div>
                            <div class="calc_tap4">
                                =
                            </div>
                            <div id="calc_result3" class="calc_tap5">
                                loading...
                            </div>
                        </div>
                    </div>
                    <!--공시지원금 버튼 선택시 보임, 요금제 할인 누를시 숨김-->
                    <div id="get_money"class="right_item">
                        <div class="right_sub">
                            공시지원금
                        </div>
                        <div id="get_money_value" class="right_value">
                        </div>
                    </div>
                    <!--요금제할인 버튼 선택시 보임, 공시지원금 누를시 숨김-->
                    <div id="total_sale_contract" class="right_item">
                        <div class="right_sub">
                            요금제할인 총금액
                        </div>
                        <div id="plan_discount_value"  class="right_value">
                        </div>
                    </div>
                    <!--사용자가 입력 가능한 값-->
                    <div id="additional_discount" class="right_item">
                        <div class="right_sub">
                            추가할인
                        </div>
                        <div id="additional_discount_value" class="right_value">
                        </div>
                    </div>
                    <div id="notice" class="right_item">
                        <div id="notice_value" class="">
                            (최종 월 납부액은 부가세 10% 와 분할상환 수수료 5.9% 포함됨)
                        </div>
                    </div>
                    <div id="button" class="right_item">
                        <div class="right_sub" style="background-color: aquamarine;">
                            신청하기 버튼
                        </div>
                    </div>
                </div><!--오른쪽 끝-->
            </div>
            <!--초기 const 변수들-->
            <script type="text/javascript" language="javascript">
                // 선택약정 할인 퍼센트 = 25%
                let DISCOUNT_PRICE_PERCENT = 0;
                // 공시지원 추가지원금 퍼센트 = 15% 
                let ADDITIONAL_DISCOUNT_PERCENT = 0;
                // 할부이자 = 6.27%
                let INSTALLMENT_MONTH_PERCENT = 0;
                // 보정금액
                let CORRECTION_NUMBER = 0;
                // 24개월 세금 계산
                let MONTH_INTEREST = 0;

                // 요금제 정보
                var PLAN_DATA;
                // 핸드폰 출고가, 보조금 정보
                var PRICE_DATA;
                // const
                var CONST_DATA;

                // 핸드폰 모델명
                // 현재 경로를 전체 url 을 나눈다
                var this_url   = window.location.pathname.split("/");
                //나누어진 배열 맨 끝이 기기이름
                var arFileName = this_url[this_url.length-2];
                var PHONE_NAME = arFileName
                // 핸드폰 이미지 색깔
                const PHONE_IMAGE = files;
                
            </script>
            <script type="text/javascript" language="javascript">
                var url = "../setting/PriceTable.xlsx";
                var oReq = new XMLHttpRequest();
                oReq.open("GET", url, true);
                oReq.responseType = "arraybuffer";
                oReq.onreadystatechange = on_ready_state;
                oReq.send();

                function on_ready_state(){
                    // 4 = 데이터 전송완료
                    if(oReq.readyState == 4) {
                        // 200 은 에러 없음을 의미 ( 404 = 페이지가 존재하지 않음 )
                        if(oReq.status == 200) {
                            var arraybuffer = oReq.response;
                            /* convert data to binary string */
                            var data = new Uint8Array(arraybuffer);
                            var arr = new Array();
                            for (var i = 0; i != data.length; ++i) arr[i] = String.fromCharCode(data[i]);
                            var bstr = arr.join("");

                            /* Call XLSX */
                            var workbook = XLSX.read(bstr, {
                                type: "binary"
                            });

                            
                            workbook.SheetNames.forEach( function(__data, idx){   //시트 여러개하려면 이곳에서 반복문
                                let sheetName = __data;
                                var worksheet = workbook.Sheets[sheetName];
                                let datas = XLSX.utils.sheet_to_json(worksheet, {raw: true});

                                // 시트의 이름이 plan이면
                                if(sheetName=='plan'){
                                    let tmp = {};
                                    datas.forEach(function(data,idx){
                                        tmp[data['name']] = data['price'];
                                    })
                                    PLAN_DATA = tmp;
                                }
                                // 시트의 이름이 price면
                                else if(sheetName == 'price'){
                                    //let tmp = {};
                                    // idx = 해당 행
                                    datas.forEach(function(data,idx){
                                        // 해당 시트의 행 중에 모델명이 현재 페이지와 일치할 경우
                                        if( data['모델명'] == PHONE_NAME)
                                            PRICE_DATA = data;
                                    })
                                }
                                // 시트의 이름이 const 일 경우
                                else if( sheetName == 'const'){
                                    CONST_DATA = datas;
                                    // 선택약정 할인 퍼센트 
                                    DISCOUNT_PRICE_PERCENT = CONST_DATA[0]['선약할인'];
                                    // 공시지원 추가지원금 퍼센트 
                                    ADDITIONAL_DISCOUNT_PERCENT = CONST_DATA[0]['공시추가지원'];
                                    // 할부이자
                                    INSTALLMENT_MONTH_PERCENT = CONST_DATA[0]['할부이자'];
                                    // 보정금액
                                    CORRECTION_NUMBER = CONST_DATA[0]['이자계산개월수'];
                                    // 24개월 세금 계산
                                    MONTH_INTEREST = CONST_DATA[0]['보정금액'];

                                }
                            })//workbook.SheetNames.forEach

                            // 핸드폰 이름을 로딩시켜줌
                            $('#phoneName').text(PRICE_DATA['기기명']);
                            // 메인 이미지를 로딩시켜줌
                            $('#main_image_div').append('<img id="main_image" src="./'+PHONE_IMAGE[0]+'.png" style="width:300px; height:300px;">');
                            // 색 고르는 이미지들을 로딩시켜줌
                            for(i=0; i<PHONE_IMAGE.length; i++){
                                var name = PHONE_IMAGE[i]
                                // 메인이미지 아래
                                $('#color_pick').append('<div class="color_pick_sub"><div><img src="'+name+'.png" style="width:40px; height:40px;"onclick="onClick_changeColor('+i+')"></div><div class="color_text">'+name+'</div></div>');

                                // radio 버튼
                                $('#radio_color').append('<label><input class="select_color" value="'+i+'"type="radio" name="radio_color"  onclick="onClick_changeColor(this.value)" checked>'+name+'</label>')
                            }// for문
                            //컬러 선택의 첫번쨰 radio를 선택으로 바꿔줌
                            $('input[name="radio_color"]:radio[value=0]').prop('checked',true);

                            // 해당 기기의 요금제 갯수
                            var plan_number = (Object.keys(PRICE_DATA).length)-11;
                            //현재 있는 요금제를 불러옴
                            var i=0;
                            for( name in PLAN_DATA){
                                if(i == plan_number) break;
                                $('#select_plan').append('<option value="'+name+'">'+name+'</option>');
                                i++
                            }//for문

                            //출고가 변경
                            change_phone_price();
                            //할부개월 변경
                            change_installment_month();
                            //특별할인(특가)변경
                            change_special_discount('공시-sk');
                            //현재 요금제 얻어옴
                            change_plan();
                            //공시지원 변경
                            change_get_money();
                            //공통변경
                            common_calculation();


                        }//if(oReq.status == 200) {
                        else {
                            alert('처리 중 에러가 발생했습니다.')
                        }
                    }//if(oReq.readyState == 4) {
                }//function on_ready_state(){
        </script>
        <!--페이지 초기 로딩시 불러오는 스크립트-->
        <script type="text/javascript" language="javascript">
            //  alert("start plan");
            //function after_load_xml(){
            //}
            //$.when(xml2json()).done(function(){
        </script>
        <!--이벤트 연결 스크립트-->
        <script type="text/javascript" language="javascript">

            // 이미지 바꾸는 함수
            function onClick_changeColor(number){
                $("#main_image").attr("src", PHONE_IMAGE[number]+".png");
                $('input[name="radio_color"]:radio[value='+number+']').prop('checked',true);
                select_color = number;
            }
            // 이벤트 연결
            $(function(){
                //현재 통신사 선택 radio
                //특별 할인값을 바꿔준 후 재계산.
                 $('input[name=radio_now_service]').change(function(e){
                    //특가 변경
                    change_special_discount();
                    common_calculation();
                 })

                 //사용할 통신사 선택 radio
                 //$('input[name=radio_after_service]').change(function(e){
                 //    radio_after_service=$(this).val();
                 //})

                //약정선택 radio
                $('input[name=radio_contract]').change(function(e){
                    kind_installlment_month = $(this).val();
                        // 공시일 때
                        if(kind_installlment_month == "공시"){
                            $('#get_money').css("display", "block");   
                            $('#additional_discount').css("display", "block");   
                            $('#total_sale_contract').css("display", "none");
                    }
                    //선택약정 일 때
                    else if(kind_installlment_month == "선약"){
                        $('#get_money').css("display", "none");   
                        $('#additional_discount').css("display", "none");   
                        $('#total_sale_contract').css("display", "block");   
                    }
                    //특가 변경
                    change_special_discount();
                    common_calculation();
                })

                // 할부 radio 골랐을 때
                $('input[name=radio_month]').change(function(e){
                    change_installment_month();
                    common_calculation();
                })
                //요금제 select
                $('#select_plan').change(function(e){
                    //현재 선택된 요금제를 숫자 형식으로 받아옴.
                    //var select_val = $('#select_plan option:selected').val();
                    change_plan();
                    common_calculation();
                })

            });
        </script>
        <!--수식 계산 스크립트-->
        <script type="text/javascript" language="javascript">
            // 요금제와 가격이 들어있는 json
            var plans = new Object();
            // ���Ŀ� �ʿ��� ����
            var phone_price;        //출고가
            var selected_plan;           //현재 요금제를 불러옴(0, 1 형식)
            var spt_price;          //공시지원금
            var additional_discount;//추가지원금
            var special_discount;   //특별지원금(특가)
            var month;              //할부개월
            //var selected_plan_char;      //현재 요금제를 불러옴(5GX 슬림 형식)
            var kind_installlment_month = "공시-sk";//현재 선택된 할인방법 0 = 공시 / 1 = 약정

            //통신요금 계산용
            //var plan_price = plans[selected_plan_char];
            // 통신요금
            var plan_price;
            // 할부원금
            var final_phone_price ;
            
            ///////////////////////////////////////////////////////////////////////
            ////////////////////초기 페이지 로딩시에만 불러옴////////////////////
            ///////////////////////////////////////////////////////////////////////
            //출고가
            function change_phone_price(){
                phone_price = PRICE_DATA['출고가'];
                $('#phone_price_value').text(numberWithCommas( phone_price+"원"));
            }
            ///////////////////////////////////////////////////////////////////////
            ///////////////////할부개월 radio를 선택했을 때에만////////////////////
            ///////////////////////////////////////////////////////////////////////
            //할부개월
            function change_installment_month(){
                month = $('input:radio[name="radio_month"]:checked').val() ;
                $('#installment_month_value').text(month+"개월");
            }
            ///////////////////////////////////////////////////////////////////////
            ///////////////////요금제 select를 선택했을 때에만////////////////////
            ///////////////////////////////////////////////////////////////////////
            //요금제
            function change_plan(){
                //현재 요금제를 불러옴(0, 1 형식)
                selected_plan = $('#select_plan option:selected').val();
                //현재 요금제를 문자 형식으로 받아옴
                //selected_plan_char = PLAN_DATA[selected_plan]['']
                //현재 요금제를 가격으로 불러옴
                plan_price = PLAN_DATA[selected_plan]
                //현재 요금을 적용시킴
                $('#plan_value').text(selected_plan);
            }
            ///////////////////////////////////////////////////////////////////////
            ///////////////현재 통신사, 할인방법 radio 눌렀을 때에만///////////////
            ///////////////////////////////////////////////////////////////////////
            // 특가를 변경함
            function change_special_discount(){
                var seleted_radio_val = $("input[name=radio_now_service]:checked").val();
                // 공시와 선약 종류.
                var kind_of_discount = $("input[name=radio_contract]:checked").val();

                var service;
                switch(seleted_radio_val){
                    case "sk" : service = kind_of_discount+"-sk"; break;
                    case "kt" : service = kind_of_discount+"-kt"; break;
                    case "lg" : service = kind_of_discount+"-lg"; break;
                    case "etc" : service = kind_of_discount+"-알뜰"; break;
                }
                special_discount = PRICE_DATA[service];
                $('#special_discount_value').text(numberWithCommas(special_discount+"원"));
            }
            ///////////////////////////////////////////////////////////////////////
            ////////////////////할인방법(공시,선약) radio 눌렀을 때에만/////////////
            ///////////////////////////////////////////////////////////////////////
            //공시지원금을
            function change_get_money(){
                // 공시지원금을 불러옴
                spt_price = PRICE_DATA[selected_plan];
                // 추가할인 = 공시지원 * 0.15
                additional_discount = parseInt(spt_price * ADDITIONAL_DISCOUNT_PERCENT);

                //폰통신요금 = 그대로
                plan_price = PLAN_DATA[selected_plan];
                //최종 할부원금 = 폰가격 - 공시지원금 - 추가지원금 - 특가
                final_phone_price = (phone_price - spt_price - additional_discount - special_discount);

                //공시지원금
                $('#get_money_value').text(numberWithCommas( spt_price+"원"));
                //공시지원금 추가지원
                $('#additional_discount_value').text(numberWithCommas(additional_discount+"원"));
            }
            //선택약정용
            function change_plan_discount(){
                var discount_price = PLAN_DATA[selected_plan] * DISCOUNT_PRICE_PERCENT;
                //통신요금 = 통신요금의 25퍼를 뺌
                plan_price = PLAN_DATA[selected_plan] - discount_price;
                // 최종 할부원금 = 폰 가격 - 특가
                final_phone_price = phone_price - special_discount;

                //총 요금 할인액
                $('#plan_discount_value').text(numberWithCommas(discount_price * month)+"원");
            }
            ///////////////////////////////////////////////////////////////////////
            /////////////////////////////////공통//////////////////////////////////
            ///////////////////////////////////////////////////////////////////////
            function common_calculation(){

                if( kind_installlment_month == "공시"){
                    change_get_money();
                }
                else if(kind_installlment_month == "선약"){
                    change_plan_discount();
                }   
                //월 할부원금 =  할부원금 / 개월 수
                var month_price = parseInt(final_phone_price / month);
                //총 세금 = 할부원금 * 0.0627
                var total_month_interest = final_phone_price * INSTALLMENT_MONTH_PERCENT;
                // 24개월 세금 = (총 세금 / 24) -3
                var month_interest = (total_month_interest / MONTH_INTEREST)-CORRECTION_NUMBER;
                //최종 가격 = 월 할부원금 + 통신요금 + 세금
                var pricep = parseInt(month_price + plan_price + month_interest);


                // 할부원금
                $('#last_price_phone_value').text(numberWithCommas(final_phone_price)+"원");
                // 월 할부원금
                $('#calc_result1').text(numberWithCommas(month_price)+"원");
                // 월 요금 가격
                $('#calc_result2').text(numberWithCommas(plan_price)+"원");
                // 최종 가격
                $('#calc_result3').text(numberWithCommas(pricep)+"원");
            }
            // 콤마 붙여주는 함수
            function numberWithCommas(x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
        </script>
    </body>
</html>